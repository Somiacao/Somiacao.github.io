<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="spark工具集概览和简单使用,">










<meta name="keywords" content="spark工具集概览和简单使用">
<meta property="og:type" content="article">
<meta property="og:title" content="spark3">
<meta property="og:url" content="http://yoursite.com/2019/03/17/spark（三）/index.html">
<meta property="og:site_name" content="最可爱的人">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/theme.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark1.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark2.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark3.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark4.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark5.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark6.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark7.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark8.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark9.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark10.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark11.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark12.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark13.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark14.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark15.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark16.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark17.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark18.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark19.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark20.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark21.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark22.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark23.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark24.png">
<meta property="og:image" content="https://somiacao.github.io/images/spark3/spark25.png">
<meta property="og:updated_time" content="2019-03-17T09:15:54.242Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="spark3">
<meta name="twitter:image" content="https://somiacao.github.io/images/spark3/theme.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/03/17/spark（三）/">





  <title>spark3 | 最可爱的人</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband">
       <a href="https://github.com/Somiacao"><img style="position: fixed; top: 0; right: 0; border: 0;" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_orange_ff7600.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    </div>
    

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">最可爱的人</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/17/spark（三）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Max Cao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="最可爱的人">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">spark3</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-17T00:00:00+08:00">
                2019-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/spark/" itemprop="url" rel="index">
                    <span itemprop="name">spark</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="https://somiacao.github.io/images/spark3/theme.png" alt="png"><br><a id="more"></a></p>
<h1 id="Spark工具集概览"><a href="#Spark工具集概览" class="headerlink" title="Spark工具集概览"></a>Spark工具集概览</h1><p>上一章，在spark的结构化api中引入了Spark的核心概念，比如transformation和action操作。这些简单的概念构建块是Apache庞大的工具和库生态系统的基础。spark是由这些原始的（底层API和结构化的API）组成，然后是一系列用于附加功能的标准库。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark1.png" alt="png"></p>
<h2 id="使用spark-submit运行生产应用程序"><a href="#使用spark-submit运行生产应用程序" class="headerlink" title="使用spark-submit运行生产应用程序"></a>使用spark-submit运行生产应用程序</h2><p>spark使开发和创建大数据变得很容易。Spark还可以轻松地将交互式探索转换为带有Spark-submit的生产应用程序，这是一个内置的命令行工具。spark-submit只做一件事：它允许将应用程序代码发送到集群并启动它在那里执行。提交后，应用程序将运行，直到它完成任务或遇到错误。可以使用Spark的所有支持集群管理器，包括standalone、Mesos和yarn。</p>
<p>spark-submit提供了几个控制项，可以在其中指定应用程序需要的资源以及它应该如何运行以及它的命令行参数。</p>
<p>下面提供一个本地机器上运行的应用程序，在spark的目录中使用以下命令：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-submit \</span><br><span class="line">--<span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">examples</span>.<span class="title">SparkPi</span> <span class="title">\</span></span></span><br><span class="line"><span class="class"><span class="title">--master</span> <span class="title">local</span> <span class="title">\</span></span></span><br><span class="line"><span class="class">.<span class="title">/examples/jars/spark-examples_2</span>.11<span class="title">-2</span>.2.0.<span class="title">jar</span> 10</span></span><br></pre></td></tr></table></figure>
<p>这个示例应用程序计算pi的数字到一定程度的估计。这里我们告诉spark-submit，我们希望在本地机器上运行，我们希望运行哪个类和哪个JAR，以及这个类的一些命令行参数。</p>
<p>通过更改spark-master的master参数，可以将相同的应用程序提交到Spark的standalone集群管理、Mesos或者yarn集群管理器。</p>
<h2 id="Dataset：用于结构化数据的类型安全api"><a href="#Dataset：用于结构化数据的类型安全api" class="headerlink" title="Dataset：用于结构化数据的类型安全api"></a>Dataset：用于结构化数据的类型安全api</h2><p>将描述的第一个API是Spark结构化API的一个类型安全版本，叫做DataSets，因为在Java和Scala中编写静态编码。</p>
<p>DataFrames是一个row类型的对象的分布式集合，可以存储不同类型的表格数据。DataSet这个API为用户提供了将Java/Scala类分配到DataFrame中记录的能力，并将其类型化对象的集合操作，类似于Java中的ArrayList或者Scala中的Seq。</p>
<p>DataSet是支持泛型的，优点是只能在你想要或需要使用它们时使用。例如，在下面的示例中，将定义我们自己的数据类型，并通过任意映射和过滤函数对其进行操作。执行操作之后，Spark可以自动的返回一个DataFrame，我们可以利用spark包含的很多函数对它进行操作。这使得它很容易下降到较低的级别，在必要的时候执行类型安全的编程，并向上移到SQL以进行更快的分析。下面是一个小示例，演示如何使用类型安全函数和类似于SQL表达式的数据框架快速编写业务逻辑：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Flight</span>(<span class="params"><span class="type">DEST_COUNTRY_NAME</span>:<span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                  <span class="type">ORIGIN_COUNTRY_NAME</span>:<span class="type">String</span>,</span></span></span><br><span class="line"><span class="class"><span class="params">                  count:<span class="type">BigData</span></span>)</span></span><br><span class="line"><span class="class"><span class="title">val</span> <span class="title">flightDF</span> </span>= spark.read.</span><br><span class="line">    parquet(<span class="string">"file:///usr/local/dataset/2010-summary.parquet/"</span>)</span><br><span class="line"><span class="keyword">val</span> flights = flightDF.as[<span class="type">Flight</span>]</span><br></pre></td></tr></table></figure>
<p>最后一个好处是，当对DataSet调用collect和take函数时，它将在你的DataSet中收集适当类型的对象，而不是DataFrame行。这样很容易获取类型安全，并以分布式和本地方式安全地执行操作，无需更改代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flights</span><br><span class="line">      .fliter(flight_row =&gt; flight_row.<span class="type">ORIGIN_COUNTRY_NAME</span> != <span class="string">"Canada"</span>)</span><br><span class="line">      .map(flight_row =&gt; flight_row)</span><br><span class="line">      .take(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flights</span><br><span class="line">      .take(<span class="number">5</span>)</span><br><span class="line">      .fliter(flight_row =&gt; flight_row.<span class="type">ORIGIN_COUNTRY_NAME</span> != <span class="string">"Canada"</span>)</span><br><span class="line">      .map(fr =&gt; <span class="type">Flight</span>(fr.<span class="type">DEST_COUNTRY_NAME</span>, fr.<span class="type">ORIGIN_COUNTRY_NAME</span>, fr.count + <span class="number">5</span>))</span><br></pre></td></tr></table></figure>
<h2 id="结构化流处理"><a href="#结构化流处理" class="headerlink" title="结构化流处理"></a>结构化流处理</h2><p>结构化流是用于流处理的高级API，在spark2.2中已经做好了生产准备。使用结构化流，可以使用spark的结构化的API以批处理模式执行相同的操作，并且以流方式运行它们。这可以减少延迟并允许增量处理。结构化流媒体最好的一点是，它可以快速地从流媒体系统中提取价值，而实际上没有代码的修改。它还使得概念化变得容易，因为你可以以编写批处理作业作为原型，然后将其转化为流式作业。所有这些工作的方式都是通过增量处理这些数据。</p>
<p>下面用一个例子来说一下开启一个结构化流是多容易啊（虽然我不这么觉得）。使用的数据集是零售数据集，它有特定的日期和时间供我们使用。使用“by-day”文件集，其中一个文件表示一天的数据。</p>
<p>我们把它设置成这种格式来模拟由不同过程以一致和规则的方式产生的数据。这是零售数据，所以假设这些数据是由零售商店产生的并且发送到一个位置，在那里我们可以读取到这些结构化流作业。</p>
<p>下面是零售数据的实例：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark2.png" alt="png"></p>
<p>为了证实这一点，首先我们将数据作为一个静态数据集进行分析并创建一个DataFrame来实现这一点。我们还可以从这个静态数据集中创建一个schema</p>
<p><img src="https://somiacao.github.io/images/spark3/spark3.png" alt="png"></p>
<p>因为使用的是时间序列的数据，所以值得一提的是我们如何对数据进行分组和聚合。在这个例子中，我们将查看给定客户（由CustomerId标识）进行大量购买的销售时间。例如，让我们添加一个“总成本”列，并查看客户花费最多的天数。</p>
<p>window函数将在聚合中包括每天的所有数据。在我们的数据中，它只是时间序列column的一个window。这是一个操作日期和时间戳的有用的工具。因为我们可以通过更人性化的形式（通过间隔）指定我们的需求，spark可以将所有需求分组在一起：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark4.png" alt="png"></p>
<p>值得一提的是，也可以像上一章那样，将其作为SQL代码运行，上面是输出的示例。</p>
<p>这是静态DataFrame版本；如果对语法熟悉的话，就应该不会有什么大发现。</p>
<p>因为你可能在本地模式下运行它，所以最好将无序分区的数量设置为更适合本地模式的分区。默认情况下，执行器数量是200，但是有些机器的执行器数量没有这么多，所以可自己设置，此处设置为5。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark5.png" alt="png"></p>
<p>既然我们已经看到了它的工作原理，那就来看一下流代码。你会注意到代码的实际变化很小。最大的变化就是我们使用了readStream方法而不是read方法，此外，还会注意到maxFilesPerTrigger选项，它只指定我们一次应该读取文件的件数。这是为了是我们的演示更加“流式”，在生产场景中可能就会被忽略掉。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark6.png" alt="png"></p>
<p>现在我们可以看一下DataFrame是否是“流式”的：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark7.png" alt="png"></p>
<p>在我们设置与前一个DataFrame操作相同的业务之前，我们将在此过程中执行求和操作：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark8.png" alt="png"></p>
<p>这是一个lazy operation（实在不明白什么叫懒惰操作，真骚），所以我们需要调用流操作来启动此数据流的执行。</p>
<p>流操作与我们传统的静态操作有点不同，因为我们将在某处填充数据，而不只是调用诸如count之类的方法（无论如何，这在流上没有任何意义）。我们将使用的操作输出到一个内存表中，我们将在每个触发器之后更新该表。在这种情况下，每个触发器都基于一个单独的文件（之前设置的读取选项）。Spark将改变内存表中的数据，这样我们僵尸中拥有前面聚合中的最高值：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark9.png" alt="png"></p>
<p>曹红梅有话说：这个地方的操作我觉得有点绝望，一开始运行这边，发现会直接报错，然后通过百度发现，可能是什么data文件中的current文件里面存了一些东西，需要删除掉current文件，然后重新启动hdfs。然后，可以正常运行了，又发现运行了一段时间，报错了，感觉是内存不足造成的，我觉得还是先放着吧！反正内存里面已经存了点，先接着往下做吧！影响心情的，嘤嘤嘤。</p>
<p>当我们启动流时，我们可以对其运行查询来调试我们将写入生产接收器的结果是什么样子：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark10.png" alt="png"></p>
<p>其实，我是有一丝绝望的，因为这边也报错了，可是我还看不懂这是什么辣鸡错误，嘤嘤嘤，但是好在结果显示了，好的，不深究，等我学完一遍再看吧！哈哈哈哈</p>
<p>你会注意到，当我们读更多的数据时，表格的组成会发生变化。对于每一个文件，结果可能会根据数据进行更改，也可能不会更改。当然，因为我们对Customers进行分组，我们希望看到随着时间的推移，顶级Customer的购买量会增加（并持续一段时间）。我们还可以使用的另一个选项是将结果写入Console：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">purchaseByCustomerPerHour.writeStream</span><br><span class="line">      .format(<span class="string">"console"</span>)</span><br><span class="line">      .queryName(<span class="string">"customer_purchase_2"</span>)</span><br><span class="line">      .outputMode(<span class="string">"compelete"</span>)</span><br><span class="line">      .start()</span><br></pre></td></tr></table></figure>
<p>我们不能再实际生产中使用这些流方法的任何一种，但是它们确实可以方便地演示结构化流的功能。注意这个window如何建立在事件时间之上的，而不是Spark处理数据的时间（又懵逼）。这是结构化流解决的Spark流的缺点之一。</p>
<h2 id="机器学习和高级分析"><a href="#机器学习和高级分析" class="headerlink" title="机器学习和高级分析"></a>机器学习和高级分析</h2><p>Spark的另一个流行方面是它能够使用一个内置的机器学习算法库MLLib执行大规模的机器学习。MLLib允许对模型进行preprocessing、munging、training，并在数据上按比例进行预测。甚至可以使用MLLib中训练模型在结构化流中进行预测。Spark提供了一个复杂的机器学习API，用于执行各种机器学习任务，从分类到回归，从Clustering到深度学习。为了演示这个功能，我们将使用一个叫做-means的标准算法对数据执行一些剧本的聚类。</p>
<p>spark包括许多现成的预处理方法。 为了演示这些方法，我们从一些原始数据开始，在将数据转化为正确格式之前建立转换，在这时，我们可以训练我们的模型然后提供预测服务：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark11.png" alt="png"></p>
<p>MLLib中机器学习算法要求将数据表示为numerical值。当前的数据是由不同的类型表示，包括时间戳、整数和字符串。因此，我们需要将这些数据转换为一些数值表示。在这个例子中，我们将使用几个DataFrame来实现操作日期数据：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark12.png" alt="png"></p>
<p>下面将数据划分为训练集和测试集，在这种情况下，我们将某个购买发生日期之前手动执行此操作；但是，也可以通过MLLib的转换API通过训练验证拆分或交叉验证创建测试集合训练集：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark13.png" alt="png"></p>
<p>现在，就根据某个时间点将数据大致划分为两个部分，测试集和训练集：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark14.png" alt="png"></p>
<p>此处请原谅小曹删掉了一部分数据，造成测试集没了数据，但是我不想再整一遍了，哈哈哈哈哈，放弃重整，因为小曹已经整了好几遍了，心痛</p>
<p>请注意，这些转换都是DataFrame转换。Spark的MLLib还提供了许多转换，通过这些转换，我们可以自动化一些常规转换。其中一个这样的转换器就是StringIndexer。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark15.png" alt="png"></p>
<p>这将把我们的星期变成相应的数值。例如，Spark可能把周六表示成6.但是使用这个编号方案，我们隐式地声明周六大于周一（纯数值）。这显然是不对的、为了解决这个问题，我们需要使用oneHotEncoder将每个值编码为它们自己的列。这些Boolean标记说明星期几是否为相关的星期几。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark16.png" alt="png"><br><img src="https://somiacao.github.io/images/spark3/spark17.png" alt="png"></p>
<p> 每一个这些编码都将组成一组列，我们将这些列“assemble”成一个向量。Spark中的所有机器学习算法都将输入一个Vector类型，该类型必须是一组numerical值：</p>
<p> <img src="https://somiacao.github.io/images/spark3/spark18.png" alt="png"></p>
<p>这边有三个关键特征：Price、quantity、the day of week。接下来，我们将这设置为pipeline以便将来我们需要转换的任何数据都可以经过完全相同的过程：</p>
<p> <img src="https://somiacao.github.io/images/spark3/spark19.png" alt="png"></p>
<p> 准备训练是一个两个步骤的过程。首先，需要将这个transformer fit到这个数据集。最基本地，StringIndexer需要知道索引的唯一值有多少。这些值存在之后，编码是很容易的，但是Spark必须查看索引的列中的所有不同值，以便在以后存储这些值：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark20.png" alt="png"></p>
<p>在拟合完这些训练数据之后，我们就可以用拟合的pipeline并且以一致和可重复的方式使用它来转换我们所有的数据。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark21.png" alt="png"></p>
<p>我们可以将训练模型包括在Pipeline上。我们不这样做是为了演示缓存数据用例。相反，我们将在模型上执行一些超参数的优化，因为我们不想要反复重复完整的转换。这就把中间转换数据集的副本放入了内存，允许我们重复以比重新运行整个pipeline低得多的成本访问它。如果想看到使用了缓存数据和没使用缓存数据的区别，可以不执行下面的语句：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark22.png" alt="png"></p>
<p>现在有了训练集，是时候训练这个模型了。首先，将导入相关的模型并将其实例化：</p>
<p><img src="https://somiacao.github.io/images/spark3/spark23.png" alt="png"></p>
<p>在spark中，训练机器学习模型是一个两个阶段的过程。首先，初始化一个未经训练的模型，然后训练它。在MLLib的DataFrame API中，每一个算法都有两种类型。对于未经过训练的版本，它们的形式是Algorithm，而对于经过训练的版本，它们的形式是AlgorithmModel。比如，KMeans和KMeansModel。</p>
<p>MLLib的DataFrame API中的Estimators大致上与我们之前看到的预处理转换器（如StringIndexer）共享大致相同的接口。这并不奇怪，因为这使得整个Pipeline（包括模型）的训练变得简单。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark24.png" alt="png"></p>
<p>这边也有点错误，无暇顾问，烦啊</p>
<p>对这个模型进行训练以后，我们可以根据训练集中一些成功的点来计算成本。这个数据集的最终成本是相当高的，这可能是因为我们没有正确的预处理和缩放数据。</p>
<p><img src="https://somiacao.github.io/images/spark3/spark25.png" alt="png"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tranformedTest = fittedPipeline.transform(testDataFrame)</span><br></pre></td></tr></table></figure>
<p>当然，我们可以继续改进这个模型，对更多的预处理进行分层，并调整超参数，以确保得到一个好的模型。</p>
<h2 id="弹性分布数据集-RDD-Spark的低级API"><a href="#弹性分布数据集-RDD-Spark的低级API" class="headerlink" title="弹性分布数据集(RDD): Spark的低级API"></a>弹性分布数据集(RDD): Spark的低级API</h2><p>Spark中包括一些较低级别的原语，以允许弹性分布式数据集（RDDS）进行任意Java和Python对象操作。实际上，Spark的所有内容都建立在RDD上。有一些事可能要用RDDs，特别是您正在读取或者操作原始数据的时候，但是大多数情况下应使用结构化API。</p>
<p>你可能会使用RDD的一件事是并行化存储在驱动机内存中的原始数据。例如，让我们并行处理一些简单的数字，然后创建一个DataFrame，然后我们可以将其转化为DataFrame，以便与其他DataFrame一起使用：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark.sparkContext.parallelize(<span class="type">Seq</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)).toDF()</span><br></pre></td></tr></table></figure>
<p>RDDs可以在scala和python中使用。然而，它们并不等同。由于一些底层实现细节，这些DataFrame API是不同的（其中执行特征相同）。作为终端用户，我们不能为了执行许多任务而大量使用RDDs,除非维护的是比较旧的Spark代码。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spark工具集概览和简单使用/" rel="tag"># spark工具集概览和简单使用</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/10/spark（二）/" rel="next" title="spark2">
                <i class="fa fa-chevron-left"></i> spark2
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/05/25/统计描述概述/" rel="prev" title="描述统计概述">
                描述统计概述 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Max Cao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spark工具集概览"><span class="nav-number">1.</span> <span class="nav-text">Spark工具集概览</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用spark-submit运行生产应用程序"><span class="nav-number">1.1.</span> <span class="nav-text">使用spark-submit运行生产应用程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dataset：用于结构化数据的类型安全api"><span class="nav-number">1.2.</span> <span class="nav-text">Dataset：用于结构化数据的类型安全api</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结构化流处理"><span class="nav-number">1.3.</span> <span class="nav-text">结构化流处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#机器学习和高级分析"><span class="nav-number">1.4.</span> <span class="nav-text">机器学习和高级分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#弹性分布数据集-RDD-Spark的低级API"><span class="nav-number">1.5.</span> <span class="nav-text">弹性分布数据集(RDD): Spark的低级API</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        ﻿<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Max Cao</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>人
</span>
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
